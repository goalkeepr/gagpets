<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NCYNBT0YWW"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-NCYNBT0YWW');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Calculate pet abilities and compare different weights for Grow a Garden game pets">
    <meta name="keywords" content="Grow a Garden, pet calculator, game tools, pet abilities">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🏡</text></svg>">
    <title>Grow a Garden - Pet Ability Calculator</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🌱 Grow a Garden</h1>
            <p>Pet Ability Calculator</p>
            <button type="button" id="darkModeToggle" class="dark-mode-toggle" aria-label="Toggle dark mode">
                <span class="toggle-icon">🌙</span>
            </button>
        </div>
        
        <div class="navigation-links">
            <a href="pettracker.html">📋 Pet Tracker</a>
            <a href="fruittypes.html">🍎 Fruit Types</a>
            <a href="recipes.html">🍳 Recipes</a>
        </div>
        
        <div class="calculator">
            <form id="petForm">
                <div class="form-group">
                    <!-- HIDDEN: Filter by Source Type section - Too many sources, hiding for now -->
                    <!-- Can be re-enabled later if needed -->
                    <!--
                    <label>Filter by Source Type:</label>
                    <select id="typeFilterSelect" class="mobile-filter-dropdown">
                        <option value="all">All Sources</option>
                        <option value="Anti Bee Egg">🐝 Anti Bee Egg</option>
                        <option value="Bee Egg">🐝 Bee Egg</option>
                        <option value="Bug Egg">🐛 Bug Egg</option>
                        <option value="Common Egg">🥚 Common Egg</option>
                        <option value="Common Summer Egg">🏖️ Common Summer Egg</option>
                        <option value="Dinosaur Egg">� Dinosaur Egg</option>
                        <option value="Enchanted Egg">✨ Enchanted Egg</option>
                        <option value="Fall Egg">🍂 Fall Egg</option>
                        <option value="Gourmet Egg">�️ Gourmet Egg</option>
                        <option value="Legendary Egg">🥚 Legendary Egg</option>
                        <option value="Mythical Egg">🥚 Mythical Egg</option>
                        <option value="Night Egg">� Night Egg</option>
                        <option value="Oasis Egg">🏜️ Oasis Egg</option>
                        <option value="Paradise Egg">� Paradise Egg</option>
                        <option value="Primal Egg">🥚 Primal Egg</option>
                        <option value="Rainbow Exotic">🌈 Rainbow Exotic</option>
                        <option value="Rare Egg">🥚 Rare Egg</option>
                        <option value="Rare Summer Egg">🏖️ Rare Summer Egg</option>
                        <option value="Spooky Egg">👻 Spooky Egg</option>
                        <option value="Sprout Egg">🌱 Sprout Egg</option>
                        <option value="Uncommon Egg">🥚 Uncommon Egg</option>
                        <option value="Zen Egg">� Zen Egg</option>
                        <option value="Fall Pet Shop">🍂 Fall Pet Shop</option>
                        <option value="Season Pass">🎫 Season Pass</option>
                        <option value="Chubby Chipmunk Event">🐿️ Chubby Chipmunk Event</option>
                        <option value="other">🔮 Other</option>
                    </select>

                    <div id="typeFilters" class="type-filters desktop-filter-buttons">
                        <button type="button" class="filter-btn active" data-type="all">All</button>
                        <button type="button" class="filter-btn" data-type="Anti Bee Egg"><span class="source-icon-placeholder" data-source="Anti Bee Egg"></span>Anti Bee</button>
                        <button type="button" class="filter-btn" data-type="Bee Egg"><span class="source-icon-placeholder" data-source="Bee Egg"></span>Bee</button>
                        <button type="button" class="filter-btn" data-type="Bug Egg"><span class="source-icon-placeholder" data-source="Bug Egg"></span>Bug</button>
                        <button type="button" class="filter-btn" data-type="Common Egg"><span class="source-icon-placeholder" data-source="Common Egg"></span>Common</button>
                        <button type="button" class="filter-btn" data-type="Common Summer Egg"><span class="source-icon-placeholder" data-source="Common Summer Egg"></span>Common Summer</button>
                        <button type="button" class="filter-btn" data-type="Dinosaur Egg"><span class="source-icon-placeholder" data-source="Dinosaur Egg"></span>Dinosaur</button>
                        <button type="button" class="filter-btn" data-type="Enchanted Egg"><span class="source-icon-placeholder" data-source="Enchanted Egg"></span>Enchanted</button>
                        <button type="button" class="filter-btn" data-type="Fall Egg"><span class="source-icon-placeholder" data-source="Fall Egg"></span>Fall</button>
                        <button type="button" class="filter-btn" data-type="Gourmet Egg"><span class="source-icon-placeholder" data-source="Gourmet Egg"></span>Gourmet</button>
                        <button type="button" class="filter-btn" data-type="Jungle Egg"><span class="source-icon-placeholder" data-source="Jungle Egg"></span>Jungle</button>
                        <button type="button" class="filter-btn" data-type="Legendary Egg"><span class="source-icon-placeholder" data-source="Legendary Egg"></span>Legendary</button>
                        <button type="button" class="filter-btn" data-type="Mythical Egg"><span class="source-icon-placeholder" data-source="Mythical Egg"></span>Mythical</button>
                        <button type="button" class="filter-btn" data-type="Night Egg"><span class="source-icon-placeholder" data-source="Night Egg"></span>Night</button>
                        <button type="button" class="filter-btn" data-type="Oasis Egg"><span class="source-icon-placeholder" data-source="Oasis Egg"></span>Oasis</button>
                        <button type="button" class="filter-btn" data-type="Paradise Egg"><span class="source-icon-placeholder" data-source="Paradise Egg"></span>Paradise</button>
                        <button type="button" class="filter-btn" data-type="Primal Egg"><span class="source-icon-placeholder" data-source="Primal Egg"></span>Primal</button>
                        <button type="button" class="filter-btn" data-type="Rainbow Exotic"><span class="source-icon-placeholder" data-source="Rainbow Exotic"></span>Rainbow Exotic</button>
                        <button type="button" class="filter-btn" data-type="Rare Egg"><span class="source-icon-placeholder" data-source="Rare Egg"></span>Rare</button>
                        <button type="button" class="filter-btn" data-type="Rare Summer Egg"><span class="source-icon-placeholder" data-source="Rare Summer Egg"></span>Rare Summer</button>
                        <button type="button" class="filter-btn" data-type="Spooky Egg"><span class="source-icon-placeholder" data-source="Spooky Egg"></span>Spooky</button>
                        <button type="button" class="filter-btn" data-type="Sprout Egg"><span class="source-icon-placeholder" data-source="Sprout Egg"></span>Sprout</button>
                        <button type="button" class="filter-btn" data-type="Uncommon Egg"><span class="source-icon-placeholder" data-source="Uncommon Egg"></span>Uncommon</button>
                        <button type="button" class="filter-btn" data-type="Zen Egg"><span class="source-icon-placeholder" data-source="Zen Egg"></span>Zen</button>
                        <button type="button" class="filter-btn" data-type="Fall Pet Shop"><span class="source-icon-placeholder" data-source="Fall Pet Shop"></span>Fall Pet Shop</button>
                        <button type="button" class="filter-btn" data-type="Season Pass"><span class="source-icon-placeholder" data-source="Season Pass"></span>Season Pass</button>
                        <button type="button" class="filter-btn" data-type="Chubby Chipmunk Event"><span class="source-icon-placeholder" data-source="Chubby Chipmunk Event"></span>Chubby Chipmunk</button>
                        <button type="button" class="filter-btn" data-type="other"><span class="source-icon-placeholder" data-source="other"></span>Other</button>
                    </div>
                    -->
                    
                    <label>Filter by Rarity:</label>
                    <!-- Mobile dropdown version -->
                    <select id="rarityFilterSelect" class="mobile-filter-dropdown">
                        <option value="all">All Rarities</option>
                        <option value="Common">Common</option>
                        <option value="Uncommon">Uncommon</option>
                        <option value="Rare">Rare</option>
                        <option value="Legendary">Legendary</option>
                        <option value="Mythical">Mythical</option>
                        <option value="Divine">Divine</option>
                        <option value="Prismatic">Prismatic</option>
                    </select>
                    <!-- Desktop button version -->
                    <div id="rarityFilters" class="type-filters desktop-filter-buttons">
                        <button type="button" class="filter-btn rarity-all active" data-rarity="all">All Rarities</button>
                        <button type="button" class="filter-btn rarity-common" data-rarity="Common" style="border-color: #ffffff;">Common</button>
                        <button type="button" class="filter-btn rarity-uncommon" data-rarity="Uncommon" style="border-color: #d3a781;">Uncommon</button>
                        <button type="button" class="filter-btn rarity-rare" data-rarity="Rare" style="border-color: #2154b9;">Rare</button>
                        <button type="button" class="filter-btn rarity-legendary" data-rarity="Legendary" style="border-color: #a3782d;">Legendary</button>
                        <button type="button" class="filter-btn rarity-mythical" data-rarity="Mythical" style="border-color: #aa55ff;">Mythical</button>
                        <button type="button" class="filter-btn rarity-divine" data-rarity="Divine" style="border-color: #ff5500;">Divine</button>
                        <button type="button" class="filter-btn rarity-prismatic" data-rarity="Prismatic" style="border-color: #ff00ff;">Prismatic</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="petSearch">Search for a Pet:</label>
                    <input type="text" id="petSearch" placeholder="Type to search pets..." aria-describedby="petSearch-help">
                    <small id="petSearch-help" class="sr-only">Search for pets by name or type</small>
                    
                    <div class="pet-grid-toggle">
                        <button type="button" id="viewToggle" class="view-toggle">Switch to Grid View</button>
                    </div>
                    
                    <label for="petSelect" style="margin-top: 15px;">Choose a Pet:</label>
                    <select id="petSelect" required aria-describedby="petSelect-help">
                        <option value="">-- Select a Pet --</option>
                    </select>
                    <small id="petSelect-help" class="sr-only">Select a pet to calculate its abilities based on weight</small>
                    
                    <div id="petGrid" class="pet-grid" aria-label="Pet selection grid"></div>
                </div>
                
                <div class="form-group">
                    <div class="checkbox-container">
                        <input type="checkbox" id="compareMode" aria-describedby="compareMode-help">
                        <label for="compareMode">Compare two pets weight/ages</label>
                        <small id="compareMode-help" class="sr-only">Enable this to compare abilities at two different weights and ages with automatic calculations</small>
                    </div>
                </div>
                
                <div id="singleWeightInput" class="form-group">
                    <div style="display: flex; gap: 15px;">
                        <div style="flex: 1;">
                            <label for="ageInput">Pet Age:</label>
                            <input type="number" id="ageInput" min="1" max="200" step="1" placeholder="Enter age" aria-describedby="ageInput-help">
                            <small id="ageInput-help" class="sr-only">Enter the pet's age</small>
                        </div>
                        <div style="flex: 1;">
                            <label for="weightInput">Pet Weight (kg):</label>
                            <input type="number" id="weightInput" min="0" step="0.01" placeholder="Enter weight in kg" required aria-describedby="weightInput-help">
                            <small id="weightInput-help" class="sr-only">Enter the pet's weight in kilograms to calculate its abilities</small>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <label for="ageSlider">Age Slider (1-100):</label>
                        <input type="range" id="ageSlider" min="1" max="100" value="50" style="width: 100%;">
                        <span id="ageSliderValue" style="font-weight: bold; margin-left: 10px;">50</span>
                    </div>
                </div>
                
                <div id="singleModifierInput" class="form-group">
                    <label for="modifierType">Pet Mutation:</label>
                    <select id="modifierType" aria-label="Select pet mutation">
                                <option value="none">None</option>
                                <option value="spectral">Spectral (8% boost to passive base)</option>
                                <option value="golden">Golden (10% boost to passive base)</option>
                                <option value="rainbow">Rainbow (20% boost to passive base)</option>
                                <option value="nightmare">Nightmare (22% boost to passive base)</option>
                                <option value="shocked">Shocked (applies lightning)</option>
                                <option value="frozen">Frozen (applies freeze)</option>
                                <option value="windy">Windy (applies windstruck)</option>
                                <option value="ironskin">IronSkin (steals fruit back)</option>
                                <option value="radiant">Radiant (advances growth)</option>
                                <option value="ascended">Ascended (applies dawnbound)</option>
                                <option value="tranquil">Tranquil (applies tranquil)</option>
                                <option value="corrupted">Corrupted (applies corrupted)</option>
                                <option value="glimmering">Glimmering (applies Glimmering)</option>
                                <option value="luminous">Luminous (applies Luminous)</option>
                                <option value="nutty">Nutty (double activation or level loss)</option>
                    </select>
                </div>
                
                <div id="compareWeightInputs" class="form-group" style="display: none;">
                    <div style="display: flex; gap: 15px;">
                        <div style="flex: 1;">
                            <label for="weight1Input">Pet 1 Weight (kg):</label>
                            <input type="number" id="weight1Input" min="0" step="0.01" placeholder="Enter first weight" aria-describedby="weight1Input-help">
                            <small id="weight1Input-help" class="sr-only">First weight for comparison</small>
                        </div>
                        <div style="flex: 1;">
                            <label for="weight2Input">Pet 2 Weight (kg):</label>
                            <input type="number" id="weight2Input" min="0" step="0.01" placeholder="Enter second weight" aria-describedby="weight2Input-help">
                            <small id="weight2Input-help" class="sr-only">Second weight for comparison</small>
                        </div>
                    </div>
                    <div id="compareAgeInputs" style="display: flex; gap: 15px; margin-top: 15px;">
                        <div style="flex: 1;">
                            <label for="age1Input">Pet 1 Age:</label>
                            <input type="number" id="age1Input" min="0" step="1" placeholder="Enter first age" aria-describedby="age1Input-help">
                            <small id="age1Input-help" class="sr-only">First age for comparison</small>
                        </div>
                        <div style="flex: 1;">
                            <label for="age2Input">Pet 2 Age:</label>
                            <input type="number" id="age2Input" min="0" step="1" placeholder="Enter second age" aria-describedby="age2Input-help">
                            <small id="age2Input-help" class="sr-only">Second age for comparison</small>
                        </div>
                    </div>
                    <div id="compareModifierInputs" style="display: flex; gap: 15px; margin-top: 15px;">
                        <div style="flex: 1;">
                            <label for="modifier1Type">Pet 1 Mutation:</label>
                            <select id="modifier1Type" aria-label="Select first pet modifier">
                                <option value="none">None</option>
                                <option value="spectral">Spectral (8% boost to passive base)</option>
                                <option value="golden">Golden (10% boost to passive base)</option>
                                <option value="rainbow">Rainbow (20% boost to passive base)</option>
                                <option value="nightmare">Nightmare (22% boost to passive base)</option>
                                <option value="shocked">Shocked (applies lightning)</option>
                                <option value="frozen">Frozen (applies freeze)</option>
                                <option value="windy">Windy (applies windstruck)</option>
                                <option value="ironskin">IronSkin (steals fruit back)</option>
                                <option value="radiant">Radiant (advances growth)</option>
                                <option value="ascended">Ascended (applies dawnbound)</option>
                                <option value="tranquil">Tranquil (applies tranquil)</option>
                                <option value="corrupted">Corrupted (applies corrupted)</option>
                                <option value="glimmering">Glimmering (applies Glimmering)</option>
                                <option value="luminous">Luminous (applies Luminous)</option>
                                <option value="nutty">Nutty (double activation or level loss)</option>
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <label for="modifier2Type">Pet 2 Mutation:</label>
                            <select id="modifier2Type" aria-label="Select second pet modifier">
                                <option value="none">None</option>
                                <option value="spectral">Spectral (8% boost to passive base)</option>
                                <option value="golden">Golden (10% boost to passive base)</option>
                                <option value="rainbow">Rainbow (20% boost to passive base)</option>
                                <option value="nightmare">Nightmare (22% boost to passive base)</option>
                                <option value="shocked">Shocked (applies lightning)</option>
                                <option value="frozen">Frozen (applies freeze)</option>
                                <option value="windy">Windy (applies windstruck)</option>
                                <option value="ironskin">IronSkin (steals fruit back)</option>
                                <option value="radiant">Radiant (advances growth)</option>
                                <option value="ascended">Ascended (applies dawnbound)</option>
                                <option value="tranquil">Tranquil (applies tranquil)</option>
                                <option value="corrupted">Corrupted (applies corrupted)</option>
                                <option value="glimmering">Glimmering (applies Glimmering)</option>
                                <option value="luminous">Luminous (applies Luminous)</option>
                                <option value="nutty">Nutty (double activation or level loss)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
            </form>
            
            <div class="button-container">
                <button type="button" class="calculate-btn" id="calculateBtn">Calculate Pet Abilities</button>
                <button type="button" class="link-btn" id="createLinkBtn">Create Link</button>
                <button type="button" class="pet-card-btn" id="petCardBtn">🎴 Pet Card</button>
            </div>
            
            <div id="impactResult" class="result" style="display: none;" role="region" aria-live="polite" aria-label="Per kilogram impact">
                <h3 id="impactTitle">📊 Per Kilogram Impact</h3>
                <p id="impactDescription"></p>
            </div>
            
            <div id="result" class="result" role="region" aria-live="polite" aria-label="Calculation results">
                <h3 id="resultTitle"></h3>
                <p id="resultDescription"></p>
            </div>
            
            <div id="compareResult" class="result" style="display: none;" role="region" aria-live="polite" aria-label="Comparison results">
                <h3 id="compareTitle"></h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                    <div style="padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 10px;">
                        <h4 id="compare1Title" style="color: #4CAF50; margin-bottom: 10px;"></h4>
                        <p id="compare1Description" style="white-space: pre-line;"></p>
                    </div>
                    <div style="padding: 15px; background: rgba(255, 152, 0, 0.1); border-radius: 10px;">
                        <h4 id="compare2Title" style="color: #FF9800; margin-bottom: 10px;"></h4>
                        <p id="compare2Description" style="white-space: pre-line;"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button type="button" class="fab" id="fabCalculateBtn" aria-label="Calculate Pet Abilities">🌱</button>

    <script type="module" src="global_bridge.js?v=202510111"></script>
    <script>
        // Direct mutation function implementation for immediate availability
        window.getPetMutationDescription = function(modifierType, kg = 50) {
            // Wait for module to load, then use it, otherwise provide fallback
            if (window.petMutationOptions) {
                const mutationMap = {
                    "shocked": "Shocked Pet Mutation",
                    "frozen": "Frozen Pet Mutation", 
                    "windy": "Windy Pet Mutation",
                    "ironskin": "IronSkin Pet Mutation",
                    "radiant": "Radiant Pet Mutation",
                    "ascended": "Ascended Pet Mutation",
                    "tranquil": "Tranquil Pet Mutation",
                    "corrupted": "Corrupted Pet Mutation",
                    "glimmering": "Glimmering Pet Mutation",
                    "luminous": "Luminous Pet Mutation",
                    "nutty": "Nutty Pet Mutation",
                    "spectral": "Spectral Pet Mutation"
                };
                
                const mutationKey = mutationMap[modifierType];
                if (!mutationKey || !window.petMutationOptions[mutationKey]) return "";
                
                if (typeof window.petMutationOptions[mutationKey].calculate === 'function') {
                    return window.petMutationOptions[mutationKey].calculate(kg, 'none');
                }
            }
            return "";
        };
    </script>
    <script>
        'use strict';
        
        // Source type icon mapping - replace these URLs with your actual image paths
        const SOURCE_ICONS = {
            'Anti Bee Egg': 'https://static.wikia.nocookie.net/growagarden/images/e/e2/AntiBeeEgg.png',
            'Bee Egg': 'https://static.wikia.nocookie.net/growagarden/images/8/8d/BeeEgg.png',
            'Bug Egg': 'https://static.wikia.nocookie.net/growagarden/images/8/86/Bugeggimage.png',
            'Common Egg': 'https://static.wikia.nocookie.net/growagarden/images/9/95/CommonEgg.png',
            'Common Summer Egg': 'https://static.wikia.nocookie.net/growagarden/images/6/62/CommonSummerEgg.png',
            'Dinosaur Egg': 'https://static.wikia.nocookie.net/growagarden/images/2/29/Dinosauregg.png',
            'Enchanted Egg': 'https://static.wikia.nocookie.net/growagarden/images/6/6b/EnchantedEgg.png',
            'Fall Egg': 'https://static.wikia.nocookie.net/growagarden/images/5/5e/Fall_Egg.png',
            'Gourmet Egg': 'https://static.wikia.nocookie.net/growagarden/images/2/2a/Gourmet_Egg.png',
            'Jungle Egg': 'https://static.wikia.nocookie.net/growagarden/images/a/a6/Jungle_Egg.png',
            'Legendary Egg': 'https://static.wikia.nocookie.net/growagarden/images/6/63/Legendary_Egg.webp',
            'Mythical Egg': 'https://static.wikia.nocookie.net/growagarden/images/4/4f/MythicalEggBetter.png',
            'Night Egg': 'https://static.wikia.nocookie.net/growagarden/images/7/71/Night_Egg.png',
            'Oasis Egg': 'https://static.wikia.nocookie.net/growagarden/images/7/73/OasisEgg.png',
            'Paradise Egg': 'https://static.wikia.nocookie.net/growagarden/images/b/ba/ParadiseSummerEgg.png',
            'Primal Egg': 'https://static.wikia.nocookie.net/growagarden/images/8/8f/PrimalEgg.png',
            'Rainbow Exotic': 'https://static.wikia.nocookie.net/growagarden/images/2/25/Images-GrowGarden-Vector_20250426011605.png',
            'Rare Egg': 'https://static.wikia.nocookie.net/growagarden/images/2/23/RareEgg.png',
            'Rare Summer Egg': 'https://static.wikia.nocookie.net/growagarden/images/6/6c/RareSummerEgg.png',
            'Spooky Egg': 'https://static.wikia.nocookie.net/growagarden/images/c/c5/Spooky_Egg.png',
            'Sprout Egg': 'https://static.wikia.nocookie.net/growagarden/images/9/96/SproutEgg.png',
            'Uncommon Egg': 'https://static.wikia.nocookie.net/growagarden/images/0/0c/Uncommon_Egg.webp',
            'Zen Egg': 'https://static.wikia.nocookie.net/growagarden/images/1/14/Zeneg.png',
            'Fall Pet Shop': 'https://static.wikia.nocookie.net/growagarden/images/f/f0/FallEventIsland.png',
            'Season Pass': 'https://static.wikia.nocookie.net/growagarden/images/1/11/Season_Pass_Icon.png',
            'Chubby Chipmunk Event': 'https://static.wikia.nocookie.net/growagarden/images/5/52/ChubbyChipmunkPet.png',
            'other': 'https://static.wikia.nocookie.net/growagarden/images/9/90/KitsuneChest.png'
        };
        
        // Helper function to create source icon HTML
        function getSourceIconHTML(sourceType, size = '16px') {
            const iconUrl = SOURCE_ICONS[sourceType];
            if (iconUrl) {
                return `<img src="${iconUrl}" alt="${sourceType}" style="width: ${size}; height: ${size}; margin-right: 4px; vertical-align: middle;" onerror="this.style.display='none';">`;
            }
            // Fallback to emoji if image not found
            const emojiMap = {
                'Common Egg': '🥚',
                'Uncommon Egg': '🥚',
                'Rare Egg': '🥚',
                'Legendary Egg': '🥚',
                'Mythical Egg': '🥚',
                'Primal Egg': '🥚',
                'Common Summer Egg': '🏖️',
                'Rare Summer Egg': '🏖️',
                'Bug Egg': '🐛',
                'Dinosaur Egg': '🦕',
                'Enchanted Egg': '✨',
                'Fall Egg': '🍂',
                'Jungle Egg': '🌴',
                'Night Egg': '🌙',
                'Season Pass': '🎫',
                'Chubby Chipmunk Event': '🐿️',
                'Spooky Egg': '👻',
                'Rainbow Exotic': '🌈',
                'other': '🔮'
            };
            return emojiMap[sourceType] || '❓';
        }
        
        // Application state management
        const AppState = {
            selectedPet: null,
            isCompareMode: false,
            isCalculating: false,
            baseAge: null,
            baseWeight: null
        };

        const App = {
            selectedPet: null,
            isCompareMode: false,
            isCalculating: false,
            baseAge: null,
            baseWeight: null,

            /**
             * Initialize the application
             */
            init() {
                console.log('🚀 App.init() called');
                console.log('🔍 Checking petAbilities:', typeof petAbilities, petAbilities ? Object.keys(petAbilities).length : 'undefined');
                
                // Ensure petAbilities is loaded
                if (typeof petAbilities === 'undefined' || !petAbilities || Object.keys(petAbilities).length === 0) {
                    console.error('❌ petAbilities not loaded properly, retrying in 100ms...');
                    setTimeout(() => this.init(), 100);
                    return;
                }
                
                console.log('✅ petAbilities confirmed loaded with', Object.keys(petAbilities).length, 'pets');
                
                DOMManager.init();
                PetDropdown.populate();
                
                // Set initial view based on screen size
                const isMobile = window.matchMedia("(max-width: 768px)").matches;
                PetDropdown.setView(isMobile);

                // Initialize event handlers after the view is set
                EventHandlers.init();
                
                // Apply URL parameters if present
                const params = URLManager.parseQueryParams();
                URLManager.applyQueryParams(params);
            }
        };

        // Constants for better maintainability
        const CONSTANTS = {
            MIN_WEIGHT: 0,
            MAX_WEIGHT: 1000,
            WEIGHT_STEP: 0.01,
            DEBOUNCE_DELAY: 300
        };

        // Age and weight calculation utility
        const AgeWeightCalculator = {
            /**
             * Handle age input changes and automatic weight calculation
             */
            handleAge1Change() {
                const age1Input = DOMManager.getElement('age1Input');
                const age2Input = DOMManager.getElement('age2Input');
                const weight1Input = DOMManager.getElement('weight1Input');
                const weight2Input = DOMManager.getElement('weight2Input');
                
                if (!age1Input || !age2Input || !weight1Input || !weight2Input) return;
                
                const age1 = parseFloat(age1Input.value || '');
                const weight1 = parseFloat(weight1Input.value || '');
                
                // Default pet 2 age to 50 if it's blank when pet 1 age is updated
                if (Utils.isValidAge(age1) && !age2Input.value) {
                    age2Input.value = '50';
                }
                
                // Update pet 2 weight based on formula if we have all required values
                this.updatePet2Weight();
            },

            /**
             * Update pet 2 weight based on the formula
             */
            updatePet2Weight() {
                const age1Input = DOMManager.getElement('age1Input');
                const age2Input = DOMManager.getElement('age2Input');
                const weight1Input = DOMManager.getElement('weight1Input');
                const weight2Input = DOMManager.getElement('weight2Input');
                
                if (!age1Input || !age2Input || !weight1Input || !weight2Input) return;
                
                const age1 = parseFloat(age1Input.value || '');
                const age2 = parseFloat(age2Input.value || '');
                const weight1 = parseFloat(weight1Input.value || '');
                
                if (Utils.isValidAge(age1) && Utils.isValidAge(age2) && Utils.isValidWeight(weight1)) {
                    // Formula: Pet 1 Weight * (10 + Pet 2 Age) / (10 + Pet 1 Age)
                    const weight2 = weight1 * (10 + age2) / (10 + age1);
                    weight2Input.value = weight2.toFixed(2);
                    
                    // Trigger calculation after weight update
                    setTimeout(() => Calculator.calculate(), 0);
                }
            }
        };

        // Single Pet Slider and dynamic weight calculation
        const SinglePetSlider = {
            /**
             * Initialize slider functionality
             */
            init() {
                const ageInput = DOMManager.getElement('ageInput');
                const weightInput = DOMManager.getElement('weightInput');
                const ageSlider = DOMManager.getElement('ageSlider');

                if (ageInput) {
                    ageInput.addEventListener('change', this.handleBaseValueChange);
                }
                if (weightInput) {
                    weightInput.addEventListener('change', this.handleBaseValueChange);
                }
                if (ageSlider) {
                    ageSlider.addEventListener('input', this.handleSliderChange);
                }
            },

            /**
             * Store base age and weight when user changes them
             */
            handleBaseValueChange() {
                const ageInput = DOMManager.getElement('ageInput');
                const weightInput = DOMManager.getElement('weightInput');
                
                if (ageInput && weightInput) {
                    const age = parseFloat(ageInput.value);
                    const weight = parseFloat(weightInput.value);

                    if (Utils.isValidAge(age) && Utils.isValidWeight(weight)) {
                        AppState.baseAge = age;
                        AppState.baseWeight = weight;
                    }
                }
            },

            /**
             * Handle slider changes for dynamic updates
             */
            handleSliderChange() {
                const ageSlider = DOMManager.getElement('ageSlider');
                const ageSliderValue = DOMManager.getElement('ageSliderValue');
                const ageInput = DOMManager.getElement('ageInput');
                const weightInput = DOMManager.getElement('weightInput');

                if (!ageSlider || !ageSliderValue || !ageInput || !weightInput) return;

                const newAge = parseInt(ageSlider.value, 10);
                
                // Update display
                ageInput.value = newAge;
                ageSliderValue.textContent = newAge;

                // Recalculate weight if base values are set
                if (AppState.baseAge !== null && AppState.baseWeight !== null && AppState.baseAge > 0) {
                    const newWeight = AppState.baseWeight * (10 + newAge) / (10 + AppState.baseAge);
                    weightInput.value = newWeight.toFixed(2);
                }

                // Trigger main calculation
                Calculator.calculate();
            }
        };

        // Utility functions
        const Utils = {
            /**
             * Format time in seconds to human readable format
             * @param {number} totalSeconds - Time in seconds
             * @returns {string} Formatted time string
             */
            formatTime(totalSeconds) {
                if (typeof totalSeconds !== 'number' || totalSeconds < 0) {
                    return '0 seconds';
                }
                
                const roundedSeconds = Math.round(Math.max(0, totalSeconds));
                if (roundedSeconds >= 60) {
                    const minutes = Math.floor(roundedSeconds / 60);
                    const seconds = roundedSeconds % 60;
                    if (seconds === 0) {
                        return `${minutes} minute${minutes !== 1 ? 's' : ''}`;
                    } else {
                        return `${minutes} minute${minutes !== 1 ? 's' : ''}, ${seconds} second${seconds !== 1 ? 's' : ''}`;
                    }
                } else {
                    return `${roundedSeconds} second${roundedSeconds !== 1 ? 's' : ''}`;
                }
            },

            /**
             * Format numbers with proper comma separation
             * @param {number} num - Number to format
             * @returns {string} Formatted number string
             */
            formatNumber(num) {
                if (typeof num !== 'number' || isNaN(num)) {
                    return '0';
                }
                
                if (num >= 1000) {
                    return num.toLocaleString();
                }
                return num.toString();
            },

            /**
             * Validate weight input
             * @param {number} weight - Weight to validate
             * @returns {boolean} True if valid
             */
            isValidWeight(weight) {
                return typeof weight === 'number' && 
                       !isNaN(weight) && 
                       weight >= CONSTANTS.MIN_WEIGHT && 
                       weight <= CONSTANTS.MAX_WEIGHT;
            },

            /**
             * Validate age input
             * @param {number} age - Age to validate
             * @returns {boolean} True if valid
             */
            isValidAge(age) {
                return typeof age === 'number' && 
                       !isNaN(age) && 
                       age >= 0 && 
                       age <= 200; // reasonable max age for pets
            },

            /**
             * Debounce function calls
             * @param {Function} func - Function to debounce
             * @param {number} delay - Delay in milliseconds
             * @returns {Function} Debounced function
             */
            debounce(func, delay) {
                let timeoutId;
                return function(...args) {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => func.apply(this, args), delay);
                };
            },

            /**
             * Sanitize HTML to prevent XSS
             * @param {string} str - String to sanitize
             * @returns {string} Sanitized string
             */
            sanitizeHTML(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },

            /**
             * Render pet icon - handles both emoji and image icons
             * @param {string|object} icon - Icon data (emoji string or icon object)
             * @returns {string} HTML for the icon
             */
            renderIcon(icon) {
                // If icon is a string (emoji), return as-is
                if (typeof icon === 'string') {
                    return icon;
                }
                
                // If icon is an object with type and url
                if (icon && typeof icon === 'object' && icon.type === 'image' && icon.url) {
                    const fallback = icon.fallback || '❓';
                    return `<img src="${this.sanitizeHTML(icon.url)}" alt="pet icon" onerror="this.style.display='none'; this.nextSibling.style.display='inline';" /><span style="display:none;">${fallback}</span>`;
                }
                
                // Fallback for invalid icon data
                return '❓';
            }
        };

        // URL and Query String utilities
        const URLManager = {
            /**
             * Parse query parameters from the current URL
             * @returns {Object} Object containing parsed parameters
             */
            parseQueryParams() {
                const params = new URLSearchParams(window.location.search);
                return {
                    pet: params.get('pet'),
                    weight: params.get('weight'),
                    weight1: params.get('weight1'),
                    weight2: params.get('weight2'),
                    age1: params.get('age1'),
                    age2: params.get('age2'),
                    compare: params.get('compare') === 'true',
                    modifier: params.get('modifier'),
                    modifier1: params.get('modifier1'),
                    modifier2: params.get('modifier2')
                };
            },

            /**
             * Create a URL with query parameters based on current form values
             * @returns {string} Complete URL with query parameters
             */
            createShareableLink() {
                const petSelect = DOMManager.getElement('petSelect');
                const compareMode = DOMManager.getElement('compareMode');
                const modifierType = DOMManager.getElement('modifierType');
                
                if (!petSelect?.value) {
                    alert('Please select a pet first!');
                    return null;
                }

                const params = new URLSearchParams();
                const baseUrl = window.location.origin + window.location.pathname;
                
                // Add pet selection
                params.set('pet', petSelect.value);
                
                // Add compare mode
                if (compareMode?.checked) {
                    params.set('compare', 'true');
                    
                    // Add weight and age values for comparison mode
                    const weight1Input = DOMManager.getElement('weight1Input');
                    const weight2Input = DOMManager.getElement('weight2Input');
                    const age1Input = DOMManager.getElement('age1Input');
                    const age2Input = DOMManager.getElement('age2Input');
                    const modifier1Type = DOMManager.getElement('modifier1Type');
                    const modifier2Type = DOMManager.getElement('modifier2Type');
                    
                    if (weight1Input?.value) params.set('weight1', weight1Input.value);
                    if (weight2Input?.value) params.set('weight2', weight2Input.value);
                    if (age1Input?.value) params.set('age1', age1Input.value);
                    if (age2Input?.value) params.set('age2', age2Input.value);
                    if (modifier1Type?.value && modifier1Type.value !== 'none') params.set('modifier1', modifier1Type.value);
                    if (modifier2Type?.value && modifier2Type.value !== 'none') params.set('modifier2', modifier2Type.value);
                } else {
                    // Add single weight for normal mode
                    const weightInput = DOMManager.getElement('weightInput');
                    if (weightInput?.value) params.set('weight', weightInput.value);
                    
                    // Add modifier for single mode
                    if (modifierType?.value && modifierType.value !== 'none') {
                        params.set('modifier', modifierType.value);
                    }
                }
                
                return `${baseUrl}?${params.toString()}`;
            },

            /**
             * Apply query parameters to form fields
             * @param {Object} params - Parsed query parameters
             */
            applyQueryParams(params) {
                try {
                    // Set pet selection
                    if (params.pet) {
                        const petSelect = DOMManager.getElement('petSelect');
                        if (petSelect) {
                            petSelect.value = params.pet;
                            AppState.selectedPet = params.pet;
                        }
                    }

                    // Set compare mode
                    if (params.compare) {
                        const compareMode = DOMManager.getElement('compareMode');
                        if (compareMode && !compareMode.checked) {
                            compareMode.checked = true;
                            ModeSwitch.toggle();
                        }
                    }

                    // Set weights and ages
                    if (params.compare) {
                        // Comparison mode values
                        if (params.weight1) {
                            const weight1Input = DOMManager.getElement('weight1Input');
                            if (weight1Input) weight1Input.value = params.weight1;
                        }
                        if (params.weight2) {
                            const weight2Input = DOMManager.getElement('weight2Input');
                            if (weight2Input) weight2Input.value = params.weight2;
                        }
                        if (params.age1) {
                            const age1Input = DOMManager.getElement('age1Input');
                            if (age1Input) age1Input.value = params.age1;
                        }
                        if (params.age2) {
                            const age2Input = DOMManager.getElement('age2Input');
                            if (age2Input) age2Input.value = params.age2;
                        }
                        
                        // Set comparison mode modifiers
                        if (params.modifier1) {
                            const modifier1Type = DOMManager.getElement('modifier1Type');
                            if (modifier1Type) modifier1Type.value = params.modifier1;
                        }
                        if (params.modifier2) {
                            const modifier2Type = DOMManager.getElement('modifier2Type');
                            if (modifier2Type) modifier2Type.value = params.modifier2;
                        }
                    } else {
                        // Single mode values
                        if (params.weight) {
                            const weightInput = DOMManager.getElement('weightInput');
                            if (weightInput) weightInput.value = params.weight;
                        }
                        
                        // Set single mode modifier
                        if (params.modifier) {
                            const modifierType = DOMManager.getElement('modifierType');
                            if (modifierType) modifierType.value = params.modifier;
                        }
                    }

                    // Trigger calculation after applying values
                    setTimeout(() => {
                        Calculator.calculate();
                    }, 100);

                } catch (error) {
                    console.error('Error applying query parameters:', error);
                }
            },

            /**
             * Copy the shareable link to clipboard and show feedback
             */
            async copyLinkToClipboard() {
                const link = this.createShareableLink();
                if (!link) return;

                try {
                    await navigator.clipboard.writeText(link);
                    
                    // Show success feedback
                    const button = DOMManager.getElement('createLinkBtn');
                    if (button) {
                        const originalText = button.textContent;
                        button.textContent = 'Link Copied!';
                        button.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
                        
                        setTimeout(() => {
                            button.textContent = originalText;
                            button.style.background = '';
                        }, 2000);
                    }
                } catch (error) {
                    // Fallback for older browsers
                    this.fallbackCopyToClipboard(link);
                }
            },

            /**
             * Fallback method for copying to clipboard
             * @param {string} text - Text to copy
             */
            fallbackCopyToClipboard(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    alert(`Link copied to clipboard:\n${text}`);
                } catch (error) {
                    alert(`Could not copy automatically. Please copy this link:\n${text}`);
                }
                
                document.body.removeChild(textArea);
            }
        };

        // Pet Card Management
        const PetCardManager = {
            /**
             * Open a new tab with the pet card for the currently selected pet
             */
            openPetCard() {
                const petSelect = DOMManager.getElement('petSelect');
                const weightInput = DOMManager.getElement('weightInput');
                const ageInput = DOMManager.getElement('ageInput');
                const modifierType = DOMManager.getElement('modifierType');

                if (!petSelect?.value) {
                    this.showError('Please select a pet first!');
                    return;
                }

                const pet = petSelect.value;
                const weight = weightInput?.value || '50';
                const age = ageInput?.value || '1';
                const mutation = modifierType?.value || 'none';

                const cardUrl = this.buildCardUrl(pet, weight, age, mutation);
                
                try {
                    const newWindow = window.open(cardUrl, '_blank');
                    if (!newWindow) {
                        this.showError('Popup blocked! Please allow popups for this site or copy the URL manually.');
                        console.log('Pet Card URL:', cardUrl);
                    }
                } catch (error) {
                    console.error('Error opening pet card:', error);
                    this.showError('Error opening pet card. Please try again.');
                }
            },

            /**
             * Build the URL for the pet card
             * @param {string} pet - Pet key
             * @param {string} weight - Pet weight
             * @param {string} age - Pet age
             * @param {string} mutation - Pet mutation
             * @returns {string} Complete URL for the pet card
             */
            buildCardUrl(pet, weight, age, mutation) {
                const params = new URLSearchParams();
                params.set('pet', pet);
                params.set('weight', weight);
                params.set('age', age);
                if (mutation && mutation !== 'none') {
                    params.set('mutation', mutation);
                }

                // Handle both root path (/) and explicit pets.html path
                let pathname = window.location.pathname;
                if (pathname === '/' || pathname === '/pets.html') {
                    pathname = '/petcard';
                } else {
                    pathname = pathname.replace('pets.html', 'petcard');
                }
                const baseUrl = window.location.origin + pathname;
                return `${baseUrl}?${params.toString()}`;
            },

            /**
             * Show error message to user
             * @param {string} message - Error message to display
             */
            showError(message) {
                // You could integrate this with an existing notification system
                alert(message);
            }
        };


        // DOM Management
        const DOMManager = {
            elements: {},
            
            /**
             * Initialize DOM element references
             */
            init() {
                this.elements = {
                    petSelect: document.getElementById('petSelect'),
                    compareMode: document.getElementById('compareMode'),
                    singleWeightDiv: document.getElementById('singleWeightInput'),
                    compareWeightDiv: document.getElementById('compareWeightInputs'),
                    weightInput: document.getElementById('weightInput'),
                    ageInput: document.getElementById('ageInput'),
                    ageSlider: document.getElementById('ageSlider'),
                    ageSliderValue: document.getElementById('ageSliderValue'),
                    weight1Input: document.getElementById('weight1Input'),
                    weight2Input: document.getElementById('weight2Input'),
                    age1Input: document.getElementById('age1Input'),
                    age2Input: document.getElementById('age2Input'),
                    resultDiv: document.getElementById('result'),
                    compareResultDiv: document.getElementById('compareResult'),
                    impactResultDiv: document.getElementById('impactResult'),
                    resultTitle: document.getElementById('resultTitle'),
                    resultDescription: document.getElementById('resultDescription'),
                    compareTitle: document.getElementById('compareTitle'),
                    compare1Title: document.getElementById('compare1Title'),
                    compare1Description: document.getElementById('compare1Description'),
                    compare2Title: document.getElementById('compare2Title'),
                    compare2Description: document.getElementById('compare2Description'),
                    impactTitle: document.getElementById('impactTitle'),
                    impactDescription: document.getElementById('impactDescription'),
                    calculateBtn: document.getElementById('calculateBtn'),
                    createLinkBtn: document.getElementById('createLinkBtn'),
                    petCardBtn: document.getElementById('petCardBtn'),
                    modifierType: document.getElementById('modifierType'),
                    singleModifierInput: document.getElementById('singleModifierInput'),
                    modifier1Type: document.getElementById('modifier1Type'),
                    modifier2Type: document.getElementById('modifier2Type')
                };
                
                // Validate all elements exist
                for (const [key, element] of Object.entries(this.elements)) {
                    if (!element) {
                        console.error(`Element not found: ${key}`);
                    }
                }
            },

            /**
             * Get element safely
             * @param {string} elementKey - Key of the element
             * @returns {HTMLElement|null} Element or null if not found
             */
            getElement(elementKey) {
                return this.elements[elementKey] || null;
            },

            /**
             * Show/hide elements with proper accessibility
             * @param {HTMLElement} element - Element to toggle
             * @param {boolean} show - Whether to show the element
             */
            toggleElement(element, show) {
                if (!element) return;
                
                if (show) {
                    element.style.display = 'block';
                    element.removeAttribute('aria-hidden');
                } else {
                    element.style.display = 'none';
                    element.setAttribute('aria-hidden', 'true');
                }
            },

            /**
             * Clear all results
             */
            clearResults() {
                const { resultDiv, compareResultDiv, impactResultDiv } = this.elements;
                
                if (resultDiv) {
                    resultDiv.className = 'result';
                    resultDiv.style.display = 'none';
                }
                
                if (compareResultDiv) {
                    compareResultDiv.className = 'result';
                    compareResultDiv.style.display = 'none';
                }

                if (impactResultDiv) {
                    impactResultDiv.className = 'result';
                    impactResultDiv.style.display = 'none';
                }
            }
        };

        // Pet dropdown management
        const PetDropdown = {
            allPets: [],
            currentFilter: 'all',
            currentRarityFilter: 'all',
            currentSearch: '',
            isGridView: false,
            selectedPetKey: null,

            /**
             * Populate dropdown with pets from petAbilities object
             */
            populate() {
                console.log('🔧 PetDropdown.populate() called');
                const petSelect = DOMManager.getElement('petSelect');
                if (!petSelect) {
                    console.error('❌ petSelect element not found');
                    return;
                }
                
                console.log('🔍 petAbilities check:', typeof petAbilities, petAbilities ? Object.keys(petAbilities).length : 'undefined');
                
                try {
                    // Get pet entries and sort them alphabetically by name
                    this.allPets = Object.entries(petAbilities).map(([key, pet]) => ({
                        key,
                        ...pet
                    })).sort((a, b) => {
                        // Ensure both pets have names before comparing
                        const nameA = a.name || '';
                        const nameB = b.name || '';
                        return nameA.localeCompare(nameB);
                    });
                    
                    console.log('✅ Successfully populated', this.allPets.length, 'pets');
                    console.log('🔧 Sample pets:', this.allPets.slice(0, 3).map(p => ({ name: p.name, type: p.type, key: p.key })));
                    
                    // Check for any pets with missing properties
                    const invalidPets = this.allPets.filter(pet => !pet.name || !pet.type);
                    if (invalidPets.length > 0) {
                        console.warn('⚠️ Found pets with missing properties:', invalidPets);
                    }
                    
                    // Trigger initial display
                    this.filterAndDisplay();
                    
                } catch (error) {
                    console.error('❌ Error populating pet dropdown:', error);
                }
            },

            /**
             * Filter and display pets based on current filters
             */
            filterAndDisplay() {
                if (this.isGridView) {
                    this.displayGrid();
                } else {
                    this.displayDropdown();
                }
            },

            /**
             * Display pets in dropdown format
             */
            displayDropdown() {
                const petSelect = DOMManager.getElement('petSelect');
                if (!petSelect) return;

                // Clear existing options except the first one
                while (petSelect.children.length > 1) {
                    petSelect.removeChild(petSelect.lastChild);
                }

                const filteredPets = this.getFilteredPets();

                // Add filtered pets to dropdown
                filteredPets.forEach(pet => {
                    const option = document.createElement('option');
                    option.value = pet.key;
                    const iconText = typeof pet.icon === 'string' ? pet.icon : (pet.icon?.fallback || '❓');
                    const rarityText = pet.rarity ? ` [${pet.rarity}]` : '';
                    const sourceText = pet.source ? ` - ${pet.source}` : '';
                    option.textContent = `${iconText} ${pet.name}${rarityText}${sourceText}`;
                    option.setAttribute('data-source', pet.source || 'Unknown');
                    option.setAttribute('data-rarity', pet.rarity || 'Unknown');
                    option.title = `${pet.description} (Source: ${pet.source || 'Unknown'}, Rarity: ${pet.rarity || 'Unknown'})`;
                    petSelect.appendChild(option);
                });

                // Show count of filtered results
                this.updateResultCount(filteredPets.length);
            },

            /**
             * Display pets in grid format
             */
            displayGrid() {
                const petGrid = document.getElementById('petGrid');
                if (!petGrid) {
                    console.error('Pet grid element not found!');
                    return;
                }

                // Ensure the grid is visible
                if (!petGrid.classList.contains('show')) {
                    petGrid.classList.add('show');
                }

                // Clear existing grid
                petGrid.innerHTML = '';

                const filteredPets = this.getFilteredPets();

                // Add filtered pets to grid
                filteredPets.forEach(pet => {
                    const petCard = document.createElement('div');
                    petCard.className = 'pet-card';
                    petCard.setAttribute('data-pet-key', pet.key);
                    petCard.setAttribute('data-rarity', pet.rarity || 'Unknown');
                    petCard.setAttribute('data-source', pet.source || 'Unknown');
                    petCard.title = `${pet.description} (Source: ${pet.source || 'Unknown'}, Rarity: ${pet.rarity || 'Unknown'})`;
                    
                    if (pet.key === this.selectedPetKey) {
                        petCard.classList.add('selected');
                    }

                    const rarityColor = this.getRarityColor(pet.rarity);
                    petCard.innerHTML = `
                        <span class="pet-icon">${Utils.renderIcon(pet.icon)}</span>
                        <div class="pet-name">${pet.name}</div>
                        <div class="pet-source">${pet.source || 'Unknown Source'}</div>
                        <div class="pet-rarity" style="color: ${rarityColor}; font-weight: bold; font-size: 0.7rem;">${pet.rarity || 'Unknown'}</div>
                    `;

                    // Create event handler function
                    const handlePetSelection = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        PetDropdown.selectPetFromGrid(pet.key);
                    };

                    // Add both click and touch events for cross-platform compatibility
                    petCard.addEventListener('click', handlePetSelection);
                    petCard.addEventListener('touchstart', (e) => {
                        // Add visual feedback on touch start
                        petCard.style.transform = 'scale(0.95)';
                    });
                    petCard.addEventListener('touchend', (e) => {
                        // Reset visual feedback and handle selection
                        petCard.style.transform = '';
                        handlePetSelection(e);
                    });
                    petCard.addEventListener('touchcancel', (e) => {
                        // Reset visual feedback if touch is cancelled
                        petCard.style.transform = '';
                    });

                    petGrid.appendChild(petCard);
                });
            },

            /**
             * Get filtered pets based on current filters
             */
            getFilteredPets() {
                console.log('🔍 Filtering pets with search:', this.currentSearch);
                const filtered = this.allPets.filter(pet => {
                    // Ensure pet properties exist and are strings
                    const petName = pet.name || '';
                    const petSource = pet.source || '';
                    const petRarity = pet.rarity || '';
                    
                    const matchesSource = this.currentFilter === 'all' || 
                                         petSource === this.currentFilter ||
                                         (this.currentFilter === 'other' && !this.isKnownSource(petSource));
                    const matchesRarity = this.currentRarityFilter === 'all' || 
                                         petRarity === this.currentRarityFilter;
                    const matchesSearch = this.currentSearch === '' || 
                                        petName.toLowerCase().includes(this.currentSearch.toLowerCase()) ||
                                        petSource.toLowerCase().includes(this.currentSearch.toLowerCase());
                    return matchesSource && matchesRarity && matchesSearch;
                });
                console.log('🔍 Filtered results:', filtered.length, 'pets');
                return filtered;
            },

            /**
             * Get color for rarity display
             */
            getRarityColor(rarity) {
                const rarityColors = {
                    'Common': '#6c757d',
                    'Uncommon': '#28a745',
                    'Rare': '#007bff',
                    'Legendary': '#ffc107',
                    'Mythical': '#e83e8c',
                    'Divine': '#17a2b8',
                    'Prismatic': '#6f42c1'
                };
                return rarityColors[rarity] || '#6c757d';
            },

            /**
             * Select pet from grid
             */
            selectPetFromGrid(petKey) {
                this.selectedPetKey = petKey;
                
                // Update grid selection visually
                const allCards = document.querySelectorAll('.pet-card');
                allCards.forEach(card => card.classList.remove('selected'));
                
                const selectedCard = document.querySelector(`[data-pet-key="${petKey}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                }

                // Update hidden select for form consistency
                const petSelect = DOMManager.getElement('petSelect');
                if (petSelect) {
                    petSelect.value = petKey;
                }

                // Update app state
                AppState.selectedPet = petKey;

                // Trigger calculation
                Calculator.calculate();
            },

            /**
             * Set the view to grid or dropdown
             * @param {boolean} isGrid - True for grid view, false for dropdown
             */
            setView(isGrid) {
                this.isGridView = isGrid;
                const container = document.querySelector('.calculator');
                const viewToggle = document.getElementById('viewToggle');
                const petGrid = document.getElementById('petGrid');

                if (!container || !viewToggle || !petGrid) {
                    console.error('Missing elements for view setup');
                    return;
                }

                if (this.isGridView) {
                    container.classList.add('grid-mode');
                    container.classList.remove('dropdown-mode');
                    viewToggle.textContent = 'Switch to Dropdown View';
                    petGrid.classList.add('show');
                } else {
                    container.classList.add('dropdown-mode');
                    container.classList.remove('grid-mode');
                    viewToggle.textContent = 'Switch to Grid View';
                    petGrid.classList.remove('show');
                }
                // Always refresh the view after changing mode
                this.filterAndDisplay();
            },

            /**
             * Toggle between grid and dropdown view
             */
            toggleView() {
                this.setView(!this.isGridView);
            },

            /**
             * Check if a source is one of the known egg sources
             */
            isKnownSource(source) {
                const knownSources = [
                    'Anti Bee Egg',
                    'Bee Egg',
                    'Common Egg',
                    'Uncommon Egg', 
                    'Rare Egg',
                    'Legendary Egg',
                    'Mythical Egg',
                    'Primal Egg',
                    'Common Summer Egg',
                    'Rare Summer Egg',
                    'Sprout Egg',
                    'Bug Egg',
                    'Dinosaur Egg',
                    'Enchanted Egg',
                    'Fall Egg',
                    'Gourmet Egg',
                    'Jungle Egg',
                    'Night Egg',
                    'Oasis Egg',
                    'Paradise Egg',
                    'Rainbow Exotic',
                    'Spooky Egg',
                    'Zen Egg',
                    'Fall Pet Shop',
                    'Season Pass',
                    'Chubby Chipmunk Event'
                ];
                return knownSources.includes(source);
            },

            /**
             * Update search filter
             */
            setSearchFilter(searchTerm) {
                console.log('🔍 Search filter set:', searchTerm);
                this.currentSearch = searchTerm;
                this.filterAndDisplay();
            },

            /**
             * Update source filter (renamed from setTypeFilter)
             */
            setSourceFilter(source) {
                this.currentFilter = source;
                this.filterAndDisplay();
            },

            /**
             * Update rarity filter
             */
            setRarityFilter(rarity) {
                this.currentRarityFilter = rarity;
                this.filterAndDisplay();
            },

            /**
             * Update result count display
             */
            updateResultCount(count) {
                const petSelect = DOMManager.getElement('petSelect');
                if (!petSelect) return;

                const firstOption = petSelect.firstElementChild;
                if (count === 0) {
                    firstOption.textContent = '-- No pets found --';
                } else if (count === this.allPets.length) {
                    firstOption.textContent = '-- Select a Pet --';
                } else {
                    firstOption.textContent = `-- Select a Pet (${count} found) --`;
                }
            }
        };

        // Calculator functionality
        const Calculator = {
            /**
             * Perform calculations based on current form state
             */
            calculate() {
                if (AppState.isCalculating) return;
                
                AppState.isCalculating = true;
                
                try {
                    const petType = DOMManager.getElement('petSelect')?.value;
                    const isCompareMode = DOMManager.getElement('compareMode')?.checked;
                    
                    DOMManager.clearResults();
                    
                    if (!petType) {
                        return; // No error shown when no pet is selected
                    }
                    
                    const pet = petAbilities[petType];
                    if (!pet) {
                        this.showError('Pet not found. Please try again.');
                        return;
                    }
                    
                    AppState.selectedPet = pet;
                    AppState.isCompareMode = isCompareMode;
                    
                    // Always show impact information when a pet is selected
                    this.showImpactResult(pet);
                    
                    if (isCompareMode) {
                        this.handleCompareMode(pet);
                    } else {
                        this.handleSingleMode(pet);
                    }
                } catch (error) {
                    console.error('Calculation error:', error);
                    this.showError('An error occurred during calculation. Please try again.');
                } finally {
                    AppState.isCalculating = false;
                }
            },

            /**
             * Handle single weight calculation
             * @param {Object} pet - Pet data object
             */
            handleSingleMode(pet) {
                const weightInput = DOMManager.getElement('weightInput');
                const modifierType = DOMManager.getElement('modifierType');
                const weight = parseFloat(weightInput?.value || '');
                const modifier = modifierType?.value || 'none';
                
                if (Utils.isValidWeight(weight)) {
                    const result = pet.calculate(weight, modifier);
                    this.showSingleResult(pet, weight, result);
                }
            },

            /**
             * Handle comparison mode calculation
             * @param {Object} pet - Pet data object
             */
            handleCompareMode(pet) {
                const weight1Input = DOMManager.getElement('weight1Input');
                const weight2Input = DOMManager.getElement('weight2Input');
                const modifier1Type = DOMManager.getElement('modifier1Type');
                const modifier2Type = DOMManager.getElement('modifier2Type');
                const weight1 = parseFloat(weight1Input?.value || '');
                const weight2 = parseFloat(weight2Input?.value || '');
                const modifier1 = modifier1Type?.value || 'none';
                const modifier2 = modifier2Type?.value || 'none';
                
                if (Utils.isValidWeight(weight1) && Utils.isValidWeight(weight2)) {
                    const result1 = pet.calculate(weight1, modifier1);
                    const result2 = pet.calculate(weight2, modifier2);
                    this.showCompareResult(pet, weight1, weight2, result1, result2, modifier1, modifier2);
                }
            },

            /**
             * Show single calculation result
             * @param {Object} pet - Pet data object
             * @param {number} weight - Pet weight
             * @param {string} result - Calculation result
             */
            showSingleResult(pet, weight, result) {
                const resultDiv = DOMManager.getElement('resultDiv');
                const resultTitle = DOMManager.getElement('resultTitle');
                const resultDescription = DOMManager.getElement('resultDescription');
                
                if (resultTitle && resultDescription && resultDiv) {
                    const rarityColor = PetDropdown.getRarityColor(pet.rarity);
                    const rarityText = pet.rarity ? ` <span style="color: ${rarityColor}; font-weight: bold;">[${pet.rarity}]</span>` : '';
                    const modifierType = DOMManager.getElement('modifierType')?.value || 'none';
                    
                    resultTitle.innerHTML = `<span class="pet-icon">${Utils.renderIcon(pet.icon)}</span> ${pet.name}${rarityText} (${weight}kg)`;
                    
                    // Add mutation description if applicable
                    let finalResult = result;
                    const mutationDesc = this.getPetMutationDescription(modifierType, weight);
                    if (mutationDesc) {
                        finalResult += `<br><br><strong>Additional Pet Mutation:</strong><br>${mutationDesc}`;
                    }
                    
                    resultDescription.innerHTML = finalResult;
                    resultDiv.style.display = 'block';
                    resultDiv.classList.add('show');
                }
            },

            /**
             * Show comparison results
             * @param {Object} pet - Pet data object
             * @param {number} weight1 - First weight
             * @param {number} weight2 - Second weight
             * @param {string} result1 - First calculation result
             * @param {string} result2 - Second calculation result
             * @param {string} modifier1 - First modifier type
             * @param {string} modifier2 - Second modifier type
             */
            showCompareResult(pet, weight1, weight2, result1, result2, modifier1 = 'none', modifier2 = 'none') {
                const elements = {
                    compareResultDiv: DOMManager.getElement('compareResultDiv'),
                    compareTitle: DOMManager.getElement('compareTitle'),
                    compare1Title: DOMManager.getElement('compare1Title'),
                    compare1Description: DOMManager.getElement('compare1Description'),
                    compare2Title: DOMManager.getElement('compare2Title'),
                    compare2Description: DOMManager.getElement('compare2Description')
                };
                
                if (Object.values(elements).every(el => el)) {
                    const rarityColor = PetDropdown.getRarityColor(pet.rarity);
                    const rarityText = pet.rarity ? ` <span style="color: ${rarityColor}; font-weight: bold;">[${pet.rarity}]</span>` : '';
                    
                    // Get modifier display text
                    const getModifierDisplay = (modifierType) => {
                        switch(modifierType) {
                            case 'golden':
                                return ' <span style="color: gold; font-weight: bold;">[Golden]</span>';
                            case 'rainbow':
                                return ' <span style="background: linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold;">[Rainbow]</span>';
                            case 'shocked':
                                return ' <span style="color: rgb(255, 255, 100); font-weight: bold;">[Shocked Pet Mutation]</span>';
                            case 'frozen':
                                return ' <span style="color: rgb(108, 184, 255); font-weight: bold;">[Frozen Pet Mutation]</span>';
                            case 'windy':
                                return ' <span style="color: rgb(162, 185, 209); font-weight: bold;">[Windy Pet Mutation]</span>';
                            case 'ironskin':
                                return ' <span style="color: rgb(206, 206, 206); font-weight: bold;">[IronSkin Pet Mutation]</span>';
                            case 'radiant':
                                return ' <span style="color: rgb(248, 108, 38); font-weight: bold;">[Radiant Pet Mutation]</span>';
                            case 'ascended':
                                return ' <span style="color: rgb(247, 245, 184); font-weight: bold;">[Ascended Pet Mutation]</span>';
                            case 'tranquil':
                                return ' <span style="color: rgb(247, 245, 184); font-weight: bold;">[Tranquil Pet Mutation]</span>';
                            default:
                                return '';
                        }
                    };
                    
                    const modifier1Display = getModifierDisplay(modifier1);
                    const modifier2Display = getModifierDisplay(modifier2);
                    
                    elements.compareTitle.innerHTML = `<span class="pet-icon">${Utils.renderIcon(pet.icon)}</span> ${pet.name}${rarityText} Comparison`;
                    elements.compare1Title.innerHTML = `<span class="pet-icon">${Utils.renderIcon(pet.icon)}</span> ${pet.name} (${weight1}kg)${modifier1Display}`;
                    
                    // Add mutation description for pet 1
                    let finalResult1 = result1;
                    const mutationDesc1 = this.getPetMutationDescription(modifier1, weight1);
                    if (mutationDesc1) {
                        finalResult1 += `<br><br><strong>Additional Pet Mutation:</strong><br>${mutationDesc1}`;
                    }
                    elements.compare1Description.innerHTML = finalResult1;
                    
                    elements.compare2Title.innerHTML = `<span class="pet-icon">${Utils.renderIcon(pet.icon)}</span> ${pet.name} (${weight2}kg)${modifier2Display}`;
                    
                    // Add mutation description for pet 2
                    let finalResult2 = result2;
                    const mutationDesc2 = this.getPetMutationDescription(modifier2, weight2);
                    if (mutationDesc2) {
                        finalResult2 += `<br><br><strong>Additional Pet Mutation:</strong><br>${mutationDesc2}`;
                    }
                    elements.compare2Description.innerHTML = finalResult2;
                    
                    elements.compareResultDiv.style.display = 'block';
                    elements.compareResultDiv.classList.add('show');
                }
            },

            /**
             * Get pet mutation description
             * @param {string} mutationType - Type of mutation
             * @param {number} weight - Pet weight in kg
             * @returns {string|null} Mutation description or null if not found
             */
            getPetMutationDescription(mutationType, weight = 50) {
                if (typeof window.getPetMutationDescription === 'function') {
                    return window.getPetMutationDescription(mutationType, weight);
                }
                return null;
            },

            /**
             * Show per-kg impact information
             * @param {Object} pet - Pet data object
             */
            showImpactResult(pet) {
                const impactDiv = DOMManager.getElement('impactResultDiv');
                const impactTitle = DOMManager.getElement('impactTitle');
                const impactDescription = DOMManager.getElement('impactDescription');
                
                if (impactTitle && impactDescription && impactDiv && pet.perKgImpact) {
                    const impact = pet.perKgImpact();
                    impactTitle.innerHTML = `📊 Per Kilogram Impact`;
                    impactDescription.innerHTML = `<strong>${impact}</strong>`;
                    impactDiv.style.display = 'block';
                    impactDiv.classList.add('show');
                }
            },

            /**
             * Show error message
             * @param {string} message - Error message to display
             */
            showError(message) {
                const resultDiv = DOMManager.getElement('resultDiv');
                const resultTitle = DOMManager.getElement('resultTitle');
                const resultDescription = DOMManager.getElement('resultDescription');
                
                if (resultTitle && resultDescription && resultDiv) {
                    resultTitle.textContent = '❌ Error';
                    resultDescription.textContent = message;
                    resultDiv.classList.add('error', 'show');
                    resultDiv.style.display = 'block';
                }
            }
        };

        // Mode switching functionality
        const ModeSwitch = {
            /**
             * Handle compare mode toggle
             */
            toggle() {
                const compareMode = DOMManager.getElement('compareMode');
                const singleWeightDiv = DOMManager.getElement('singleWeightDiv');
                const compareWeightDiv = DOMManager.getElement('compareWeightDiv');
                const singleModifierInput = DOMManager.getElement('singleModifierInput');
                const weightInput = DOMManager.getElement('weightInput');
                const weight1Input = DOMManager.getElement('weight1Input');
                const weight2Input = DOMManager.getElement('weight2Input');
                
                if (!compareMode) return;
                
                const isCompareMode = compareMode.checked;
                
                if (isCompareMode) {
                    // Copy existing weight to first compare input
                    if (weightInput?.value && !weight1Input?.value) {
                        weight1Input.value = weightInput.value;
                    }
                    
                    // Hide single mode inputs but show compare mode inputs
                    DOMManager.toggleElement(singleWeightDiv, false);
                    DOMManager.toggleElement(compareWeightDiv, true);
                    DOMManager.toggleElement(singleModifierInput, false);
                    
                    this.updateRequiredAttributes(false);
                } else {
                    // Copy first compare weight back to single input
                    if (weight1Input?.value && !weightInput?.value) {
                        weightInput.value = weight1Input.value;
                    }
                    
                    // Show single mode inputs but hide compare mode inputs
                    DOMManager.toggleElement(singleWeightDiv, true);
                    DOMManager.toggleElement(compareWeightDiv, false);
                    DOMManager.toggleElement(singleModifierInput, true);
                    
                    this.updateRequiredAttributes(true);
                }
                
                DOMManager.clearResults();
                
                // Trigger calculation after mode change
                setTimeout(() => Calculator.calculate(), 0);
            },

            /**
             * Update required attributes based on mode
             * @param {boolean} singleMode - Whether in single mode
             */
            updateRequiredAttributes(singleMode) {
                const weightInput = DOMManager.getElement('weightInput');
                const weight1Input = DOMManager.getElement('weight1Input');
                const weight2Input = DOMManager.getElement('weight2Input');
                const age1Input = DOMManager.getElement('age1Input');
                const age2Input = DOMManager.getElement('age2Input');
                
                if (singleMode) {
                    weightInput?.setAttribute('required', 'required');
                    weight1Input?.removeAttribute('required');
                    weight2Input?.removeAttribute('required');
                    age1Input?.removeAttribute('required');
                    age2Input?.removeAttribute('required');
                } else {
                    weightInput?.removeAttribute('required');
                    weight1Input?.setAttribute('required', 'required');
                    weight2Input?.setAttribute('required', 'required');
                    // Age inputs are optional but help with automatic calculation
                }
            }
        };

        // Event handlers
        const EventHandlers = {
            /**
             * Initialize all event listeners
             */
            init() {
                this.setupCalculationEvents();
                this.setupModeToggle();
                this.setupButtons();
                this.setupKeyboardNavigation();
                this.initializeSourceIcons();
                this.setupDarkModeToggle();
                SinglePetSlider.init();
            },

            /**
             * Setup calculation-related events
             */
            setupCalculationEvents() {
                const debouncedCalculate = Utils.debounce(() => Calculator.calculate(), CONSTANTS.DEBOUNCE_DELAY);
                
                // Real-time calculation as user types
                DOMManager.getElement('weightInput')?.addEventListener('input', debouncedCalculate);
                DOMManager.getElement('weight1Input')?.addEventListener('input', () => {
                    AgeWeightCalculator.updatePet2Weight();
                    debouncedCalculate();
                });
                DOMManager.getElement('weight2Input')?.addEventListener('input', debouncedCalculate);
                DOMManager.getElement('petSelect')?.addEventListener('change', () => Calculator.calculate());
                DOMManager.getElement('modifierType')?.addEventListener('change', debouncedCalculate);
                DOMManager.getElement('modifier1Type')?.addEventListener('change', debouncedCalculate);
                DOMManager.getElement('modifier2Type')?.addEventListener('change', debouncedCalculate);

                // Age input handling
                DOMManager.getElement('age1Input')?.addEventListener('input', () => {
                    AgeWeightCalculator.handleAge1Change();
                    debouncedCalculate();
                });
                DOMManager.getElement('age2Input')?.addEventListener('input', () => {
                    AgeWeightCalculator.updatePet2Weight();
                    debouncedCalculate();
                });

                // Search functionality
                const petSearch = document.getElementById('petSearch');
                if (petSearch) {
                    console.log('🔍 Setting up search event listener');
                    const debouncedSearch = Utils.debounce((searchTerm) => {
                        console.log('🔍 Debounced search called with:', searchTerm);
                        PetDropdown.setSearchFilter(searchTerm);
                    }, 200);

                    petSearch.addEventListener('input', (e) => {
                        console.log('🔍 Search input event:', e.target.value);
                        debouncedSearch(e.target.value);
                    });
                } else {
                    console.error('❌ petSearch element not found');
                }

                // Type filter functionality
                const filterButtons = document.querySelectorAll('.filter-btn[data-type]');
                filterButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        // Remove active class from all type filter buttons
                        filterButtons.forEach(btn => btn.classList.remove('active'));
                        // Add active class to clicked button
                        button.classList.add('active');
                        // Apply filter
                        const filterType = button.getAttribute('data-type');
                        PetDropdown.setSourceFilter(filterType);
                        // Sync mobile dropdown
                        const typeSelect = document.getElementById('typeFilterSelect');
                        if (typeSelect) {
                            typeSelect.value = filterType;
                        }
                    });
                });

                // Mobile source filter dropdown
                const typeFilterSelect = document.getElementById('typeFilterSelect');
                if (typeFilterSelect) {
                    typeFilterSelect.addEventListener('change', () => {
                        const filterType = typeFilterSelect.value;
                        PetDropdown.setSourceFilter(filterType);
                        // Sync desktop buttons
                        filterButtons.forEach(btn => btn.classList.remove('active'));
                        const targetButton = document.querySelector(`[data-type="${filterType}"]`);
                        if (targetButton) {
                            targetButton.classList.add('active');
                        }
                    });
                }

                // Rarity filter functionality
                const rarityFilterButtons = document.querySelectorAll('.filter-btn[data-rarity]');
                rarityFilterButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        // Remove active class from all rarity filter buttons
                        rarityFilterButtons.forEach(btn => btn.classList.remove('active'));
                        // Add active class to clicked button
                        button.classList.add('active');
                        // Apply filter
                        const filterRarity = button.getAttribute('data-rarity');
                        PetDropdown.setRarityFilter(filterRarity);
                        // Sync mobile dropdown
                        const raritySelect = document.getElementById('rarityFilterSelect');
                        if (raritySelect) {
                            raritySelect.value = filterRarity;
                        }
                    });
                });

                // Mobile rarity filter dropdown
                const rarityFilterSelect = document.getElementById('rarityFilterSelect');
                if (rarityFilterSelect) {
                    rarityFilterSelect.addEventListener('change', () => {
                        const filterRarity = rarityFilterSelect.value;
                        PetDropdown.setRarityFilter(filterRarity);
                        // Sync desktop buttons
                        rarityFilterButtons.forEach(btn => btn.classList.remove('active'));
                        const targetButton = document.querySelector(`[data-rarity="${filterRarity}"]`);
                        if (targetButton) {
                            targetButton.classList.add('active');
                        }
                    });
                }

                // View toggle functionality
                const viewToggle = document.getElementById('viewToggle');
                if (viewToggle) {
                    viewToggle.addEventListener('click', () => {
                        PetDropdown.toggleView();
                    });
                }
            },

            /**
             * Setup mode toggle event
             */
            setupModeToggle() {
                DOMManager.getElement('compareMode')?.addEventListener('change', () => ModeSwitch.toggle());
            },

            /**
             * Setup button event handlers
             */
            setupButtons() {
                // Calculate button
                const calculateBtn = DOMManager.getElement('calculateBtn');
                if (calculateBtn) {
                    calculateBtn.addEventListener('click', () => {
                        Calculator.calculate();
                    });
                }

                // Create link button
                const createLinkBtn = DOMManager.getElement('createLinkBtn');
                if (createLinkBtn) {
                    createLinkBtn.addEventListener('click', () => {
                        URLManager.copyLinkToClipboard();
                    });
                }

                // Pet card button
                const petCardBtn = DOMManager.getElement('petCardBtn');
                if (petCardBtn) {
                    petCardBtn.addEventListener('click', () => {
                        PetCardManager.openPetCard();
                    });
                }

                // FAB button for mobile
                const fabCalculateBtn = document.getElementById('fabCalculateBtn');
                if (fabCalculateBtn) {
                    fabCalculateBtn.addEventListener('click', () => {
                        Calculator.calculate();
                    });
                }
            },

            /**
             * Setup keyboard navigation enhancements
             */
            setupKeyboardNavigation() {
                // Enhanced keyboard navigation for form
                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' && event.target.tagName === 'INPUT') {
                        event.preventDefault();
                        Calculator.calculate();
                    }
                });
            },

            /**
             * Initialize source icons for filter buttons
             */
            initializeSourceIcons() {
                // Replace emoji placeholders with PNG images
                document.querySelectorAll('.source-icon-placeholder').forEach(placeholder => {
                    const sourceType = placeholder.getAttribute('data-source');
                    placeholder.innerHTML = getSourceIconHTML(sourceType);
                });
                
                // Handle the Mythical Egg button specifically (due to encoding issues)
                const mythicalButton = document.querySelector('button[data-type="Mythical Egg"]');
                if (mythicalButton) {
                    mythicalButton.innerHTML = '<span class="source-icon-placeholder" data-source="Mythical Egg"></span>Mythical';
                    // Re-initialize the icon for this button
                    const mythicalPlaceholder = mythicalButton.querySelector('.source-icon-placeholder');
                    if (mythicalPlaceholder) {
                        mythicalPlaceholder.innerHTML = getSourceIconHTML('Mythical Egg');
                    }
                }
                
                // Update mobile dropdown options with icons (prepend icons)
                const mobileSelect = document.getElementById('typeFilterSelect');
                if (mobileSelect) {
                    Array.from(mobileSelect.options).forEach(option => {
                        if (option.value !== 'all') {
                            const iconHTML = getSourceIconHTML(option.value);
                            // For dropdowns, we need to handle differently since HTML in option text isn't well supported
                            // We'll leave dropdown as text-only for better compatibility
                        }
                    });
                }
            },

            /**
             * Setup dark mode toggle functionality
             */
            setupDarkModeToggle() {
                const darkModeToggle = document.getElementById('darkModeToggle');
                if (!darkModeToggle) return;

                // Initialize theme from localStorage or default to light
                const savedTheme = localStorage.getItem('darkMode');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const initialTheme = savedTheme || (prefersDark ? 'dark' : 'light');
                
                this.setTheme(initialTheme);

                // Toggle event listener
                darkModeToggle.addEventListener('click', () => {
                    const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                    this.setTheme(newTheme);
                });

                // Listen for system theme changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                    if (!localStorage.getItem('darkMode')) {
                        this.setTheme(e.matches ? 'dark' : 'light');
                    }
                });
            },

            /**
             * Set the theme and save to localStorage
             * @param {string} theme - 'light' or 'dark'
             */
            setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('darkMode', theme);
                
                // Update toggle button icon
                const toggleIcon = document.querySelector('.dark-mode-toggle .toggle-icon');
                if (toggleIcon) {
                    toggleIcon.textContent = theme === 'dark' ? '☀️' : '🌙';
                }
            }
        };

        // App Initialization
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🔧 DOM Content Loaded');
            
            // Listen for pet data loaded event
            window.addEventListener('petDataLoaded', (event) => {
                console.log('🎉 Pet data loaded event received:', event.detail);
                App.init();
            });
            
            // Add a small delay to ensure all scripts are loaded
            setTimeout(() => {
                console.log('⏰ Timeout init fallback');
                App.init();
            }, 200);
        });
    </script>
</body>
</html>
